/* eslint-disable no-undef */
const calendars = [
  {
    'color': '#777777',
    'id': 'blj7esp5ns5sbirko1p7amr4ig@group.calendar.google.com',
    'summary': 'San Luis Obispo H3'
  },
  {
    'color': '#777777',
    'id': 'c_95c7557021b96e1c88a6df5a9132ac59082e1bfc2c2ba3eb4dc7f70b84155caa@group.calendar.google.com',
    'summary': 'Stand Up Paddling H3'
  },
  {
    'color': '#777777',
    'id': 'c_d4df77733f363a930426db4e78e11a4de74383a16027a2e134c4514c9ab4e310@group.calendar.google.com',
    'summary': 'Whittier H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_61a83meeg5us45g7fecufe1ig0@group.calendar.google.com',
    'summary': 'San Diego H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_92nnvc88c7r57nv7jp6pcf7mhk@group.calendar.google.com',
    'summary': 'Inland Empire H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_bhu8is1obunl6b0g1p9679dob4@group.calendar.google.com',
    'summary': 'Jackalope, Lancaster, & Palmdale Valley H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_ck3rfvpaupl5oieosvdpldu5co@group.calendar.google.com',
    'summary': 'Santa Barbara H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_cpeuq6vla0pbh7sp61t28ksrgg@group.calendar.google.com',
    'summary': 'Westside Pirates H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_di50tsjofkeh6024436u7fucso@group.calendar.google.com',
    'summary': 'Santa Clarita Valley H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_gnqv4s36ufg7jq3rhjbe9956uo@group.calendar.google.com',
    'summary': 'Randsburg H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_vca9alu5cu5q2hkvip31fma6so@group.calendar.google.com',
    'summary': 'Get A Life H3'
  },
  {
    'color': '#dc3232',
    'id': 'hash.org_apdt0s7aam1mdl1ckc4n1rcc4k@group.calendar.google.com',
    'summary': 'Long Beach H3'
  },
  {
    'color': '#cd6d40',
    'id': 'hash.org_gr8mpprvpgpiihhkfj0dd0ic4k@group.calendar.google.com',
    'summary': 'Orange County H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_bqjrp8qb2ne5d72s7i22a0f9m0@group.calendar.google.com',
    'summary': 'Special Event'
  },
  {
    'color': '#349ce9',
    'id': 'hash.org_8er4h3q5qct5apu9nl2v7ic4c0@group.calendar.google.com',
    'summary': 'Los Angeles H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_usu1t0e08b8pmgiub20vu3uh8o@group.calendar.google.com',
    'summary': 'Hot Flash H3'
  },
  {
    'color': '#58d7e3',
    'id': 'hash.org_f9pd9rqdl9p4o5p2ierccb2dbk@group.calendar.google.com',
    'summary': 'Ventura H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_vs1a87f9anqe0c66h2knc4nd14@group.calendar.google.com',
    'summary': 'Happy Hour H3'
  },
  {
    'color': '#777777',
    'id': '529ih4iun7rs62rbdban4838i0@group.calendar.google.com',
    'summary': 'Hash Events'
  },
  {
    'color': '#7950df',
    'id': 'hash.org_8jis0j5k0hanmgq2c6inrf93ho@group.calendar.google.com',
    'summary': 'OC Hump H3'
  },
  {
    'color': '#457a51',
    'id': 'hash.org_qhs75uc6iedipkaopd5froa80k@group.calendar.google.com',
    'summary': 'BOHICA H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_ljnt8tvbnb2lhqp0ib6pu7p5bo@group.calendar.google.com',
    'summary': 'GSpot'
  },
  {
    'color': '#777777',
    'id': 'hash.org_atjdvmkhl2fa3n2cer8m9mlsv4@group.calendar.google.com',
    'summary': 'SCV H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_6ocimc04ghdh7652dlvnjs5060@group.calendar.google.com',
    'summary': 'Foothill H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_tgkkji1arc133kf0vsjofrsod8@group.calendar.google.com',
    'summary': 'Full Moon H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_t8of6q45k4cki650d97m0b80dc@group.calendar.google.com',
    'summary': 'Signal Hill H3'
  },
  {
    'color': '#ff69b4',
    'id': 'hash.org_a92amemeo3ulb9lso3kog1k0jg@group.calendar.google.com',
    'summary': 'PMS H3'
  },
  {
    'color': '#fbf052',
    'id': 'hash.org_0si8oud4j5upnojfbimg60snag@group.calendar.google.com',
    'summary': 'Humpin’ H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_efk2ibem9h2lonqgignpcp8uoo@group.calendar.google.com',
    'summary': 'Throw Down H3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_v35g0trihcm3ip2pvoj16ancf4@group.calendar.google.com',
    'summary': 'Metro Sexual Hash - MSH3'
  },
  {
    'color': '#777777',
    'id': 'hash.org_t92ud36ad0jbao70f22d2eptuc@group.calendar.google.com',
    'summary': 'East LA H3'
  }
];

const computedSymbol = Symbol('computed');
const today = new Date();

const endOfNextYear = new Date((today).getFullYear() + 2, 0);
const startOfToday = new Date(new Intl.DateTimeFormat([], { dateStyle: 'full' }).format(today));
const startOfTodayTime = startOfToday.getTime();

const beginningOfTheWeek = new Date((new Date(startOfToday)).setDate(startOfToday.getDate() - startOfToday.getDay()));

const promises = calendars.map(calendar => {
  return `https://www.googleapis.com/calendar/v3/calendars/${calendar.id}/events?calendarId=${calendar.id}&sanitizeHtml=true&timeMax=${endOfNextYear.toISOString()}&timeMin=${beginningOfTheWeek.toISOString()}&key=AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs`;
}).map(url => {
  return fetch(url).then(response => response.json());
});
Promise.allSettled(promises).then((data) => {
  const allEvents = [];
  const eventsByDay = {};
  data.forEach(({ value: calendar }, index) => {
    calendar.items.filter(item => {
      // Filter out canceled events that don’t have start dates
      return !!item.start;
    }).forEach(item => {
      const endDay = item.end.dateTime ? item.end.dateTime.slice(0, 10) : item.end.date;
      const startDay = item.start.dateTime ? item.start.dateTime.slice(0, 10) : item.start.date;
      if (eventsByDay[startDay] === undefined) {
        eventsByDay[startDay] = [];
      }
      item[computedSymbol] = {
        calendar,
        calendarData: calendars[index],
        endDay,
        startDay
      };
      allEvents.push(item);
      eventsByDay[startDay].push(item);
    });
  });
  const recurringEvents = allEvents.filter(event => {
    return event.recurrence;
  }).map(event => {
    return `https://www.googleapis.com/calendar/v3/calendars/${event[computedSymbol].calendarData.id}/events/${event.id}/instances?calendarId=${event[computedSymbol].calendarData.id}&sanitizeHtml=true&timeMax=${endOfNextYear.toISOString()}&timeMin=${beginningOfTheWeek.toISOString()}&key=AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs`;
  }).map(url => {
    return fetch(url).then(response => response.json());
  });
  Promise.allSettled(recurringEvents).then((data) => {
    data.forEach(({ value: calendar }) => {
      calendar.items.forEach(item => {
        const endDay = item.end.dateTime ? item.end.dateTime.slice(0, 10) : item.end.date;
        const startDay = item.start.dateTime ? item.start.dateTime.slice(0, 10) : item.start.date;
        if (eventsByDay[startDay] === undefined) {
          eventsByDay[startDay] = [];
        }
        const calendarData = calendars.find(calendarItem => {
          return item.organizer.email === calendarItem.id;
        });
        item[computedSymbol] = {
          calendar,
          calendarData,
          endDay,
          startDay
        };
        // This is required for recurring events that have not been customized yet
        const eventAlreadyExists = eventsByDay[startDay].find(event => {
          return event.id === item.id;
        });
        if (!eventAlreadyExists) {
          allEvents.push(item);
          eventsByDay[startDay].push(item);
        }
      });
    });

    // All-day events
    const allDayEvents = allEvents.filter(event => {
      return event[computedSymbol].startDay !== event[computedSymbol].endDay;
    });
    allDayEvents.forEach(event => {
      const endDate = event.end.dateTime ? new Date(event.end.dateTime) : stringToDate(event.end.date);
      const startDate = event.start.dateTime ? new Date(event.start.dateTime) : stringToDate(event.start.date);
      const mutableIterationDate = new Date(startDate);
      while (mutableIterationDate <= endDate) {
        mutableIterationDate.setDate(mutableIterationDate.getDate() + 1);
        const day = mutableIterationDate.toISOString().slice(0, 10);
        const dayTime = stringToDate(day).getTime();
        if (dayTime > new Date(startDate).getTime() && dayTime < new Date(endDate).getTime()) {
          if (eventsByDay[day] === undefined) {
            eventsByDay[day] = [];
          }
          eventsByDay[day].push(event);
        }
      }
    });

    const filteredDays = Object.keys(eventsByDay).sort().filter(day => {
      return stringToDate(day) >= beginningOfTheWeek;
    });
    const days = filteredDays.map(day => {
      const events = eventsByDay[day].sort(sortByStartDate);
      return {
        day,
        dayLocalized: new Intl.DateTimeFormat([], {
          dateStyle: 'full'
        }).format(stringToDate(day)),
        events
      };
    });

    const calendarDates = [beginningOfTheWeek];
    const mutableIterationDate = new Date(beginningOfTheWeek);
    const lastDay = new Date(filteredDays[filteredDays.length - 1]);
    while (mutableIterationDate <= lastDay) {
      mutableIterationDate.setDate(mutableIterationDate.getDate() + 1);
      calendarDates.push(new Date(mutableIterationDate));
    }
    const endOfTheLastWeek = new Date((new Date(mutableIterationDate)).setDate(mutableIterationDate.getDate() + (6 - mutableIterationDate.getDay())));
    while (mutableIterationDate < endOfTheLastWeek) {
      mutableIterationDate.setDate(mutableIterationDate.getDate() + 1);
      calendarDates.push(new Date(mutableIterationDate));
    }

    const calendarDatesByMonth = {};
    calendarDates.forEach(calendarDate => {
      const yearMonth = `${calendarDate.getFullYear()}-${calendarDate.getMonth()}`;
      if (!calendarDatesByMonth[yearMonth]) {
        calendarDatesByMonth[yearMonth] = [];
      }
      calendarDatesByMonth[yearMonth].push(calendarDate);
    });

    const calendarDatesWithMonths = [];
    for (const yearMonth in calendarDatesByMonth) {
      calendarDatesWithMonths.push({
        dates: calendarDatesByMonth[yearMonth],
        yearMonth
      });
    }

    function localizedStringForDate(date, locales, options) {
      if (date.toLocaleTimeString) {
        try {
          return date.toLocaleTimeString(locales, options);
        } catch (error) {
          return date.toLocaleTimeString();
        }
      }
      return date.toString();
    }

    function startTimeForEvent(event, day) {
      const options = {
        timeStyle: 'short',
        timeZone: event[computedSymbol].calendar.timeZone
      };
      if (day !== event.start.dateTime.slice(0, 10)) {
        if (day === event.end.dateTime.slice(0, 10)) {
          return `Ends at ${localizedStringForDate(new Date(event.end.dateTime), undefined, options)}`;
        } else {
          return 'All-day';
        }
      }
      return localizedStringForDate(new Date(event.start.dateTime), undefined, options);
    }

    let currentView = localStorage.getItem('view') || 'month';
    window.activateView = (view) => {
      currentView = view;
      document.querySelector('.nav').innerHTML = getNavContents();
      document.querySelector('main').innerHTML = getMainContents();
      localStorage.setItem('view', view);
    };
    function getMainContents() {
      return `
        ${getUpcomingEventsView()}
        ${currentView === 'list' ? getListView() : getMonthView()}
      `;
    }
    function getNavContents() {
      return `
        <li class="nav-item">
          <a aria-current="page" class="${currentView === 'list' ? 'active' : ''} nav-link" onclick="activateView('list')">List</a>
        </li>
        <li class="nav-item">
          <a class="${currentView === 'month' ? 'active' : ''} nav-link" onclick="activateView('month')">Calendar</a>
        </li>
      `;
    }
    function getListView() {
      return `
        <dl class="list">
        ${days.filter(({ day }) => {
          return stringToDate(day) >= startOfToday;
        }).map(({ day, dayLocalized, events }, index) => {
          const firstDayPrefix = (index === 0 && stringToDate(day).getTime() !== startOfTodayTime) ? `
          <div>
            <dt class="frosted-background">${new Intl.DateTimeFormat([], {
              dateStyle: 'full'
            }).format(today)}</dt>
            <dd class="mx-2"></dd>
            <dd class="py-1" style="border-left: .25rem solid rgb(220,53,69)">
              <p class="my-0 one-line px-2 text-muted"><small>Today</small></p>
              <p class="my-0 one-line px-2">No trails.</p>
            </dd>
          </div>
        ` : '';
          return `${firstDayPrefix}
            <div>
              <dt class="frosted-background">${dayLocalized}</dt>
              ${events.map(event => { return getListEventView(day, event) }).join('')}
            </div>
          `;
        }).join('')
}
        </dl>
      `;
    }
    function getListEventView(day, event) {
      return `
          <dd class="py-1">
            <a class="d-block" data-bs-target="#event-${event.id}" data-bs-toggle="modal" style="border-left: .25rem solid ${event[computedSymbol].calendarData.color}">
              <p class="my-0 one-line px-2 text-muted"><small>${event.start.dateTime ? startTimeForEvent(event, day) : 'All-day'}</small></p>
              <p class="my-0 one-line px-2">${event.summary}</p>
              ${event.location ? `<p class="my-0 one-line px-2 text-muted"><small>${event.location}</small></p>` : ''}
            </a>
          </dd>
        `;
    }
    function getMonthView() {
      return `
        ${
        calendarDatesWithMonths.filter(({ dates }) => {
          // TODO: consider removing this filter
          const firstDateWithEventsStartingToday = dates.find(calendarDate => {
            if (calendarDate >= today) {
              return true;
            }
            const day = calendarDate.toISOString().slice(0, 10);
            const events = eventsByDay[day];
            return events && events.length > 0 && events.find(event => {
              const startDate = event.start.dateTime ? new Date(event.start.dateTime) : stringToDate(event.start.date);
              return startDate >= today;
            });
          });
          return firstDateWithEventsStartingToday;
        }).map(({ dates }) => {
          const firstDate = dates[0];
          const lastDate = dates[dates.length - 1];
          const endFillerDays = lastDate.getDay() === 6 ? [] : Array(6 - lastDate.getDay()).fill(undefined);
          const startFillerDays = firstDate.getDay() === 0 ? [] : Array(firstDate.getDay()).fill(undefined);
          // TODO: consider getting the first day of the week with Intl.Locale.prototype.weekInfo
          return `
            <div>
              <header class="frosted-background sticky-top">
                <h2 class="m-2">${new Intl.DateTimeFormat([], { month: 'long', year: 'numeric' }).format(dates[0])}</h2>
                <ol class="calendar list-unstyled m-0 text-center">
                  <li class="one-line">Sun</li>
                  <li class="one-line">Mon</li>
                  <li class="one-line">Tue</li>
                  <li class="one-line">Wed</li>
                  <li class="one-line">Thu</li>
                  <li class="one-line">Fri</li>
                  <li class="one-line">Sat</li>
                </ol>
              </header>
              <ol class="calendar events list-unstyled m-0">
                ${startFillerDays.map(() => {
                  return `<li class="filler"></li>`;
                }).join('')}
                ${dates.map(getMonthDayView).join('')}
                ${endFillerDays.map(() => {
                  return `<li class="filler"></li>`;
                }).join('')}
              </ol>
            </div>
          `;
        }).join('')
        }
      `;
    }
    function getMonthDayView(calendarDate) {
      const day = calendarDate.toISOString().slice(0, 10);
      const events = eventsByDay[day];
      return `
        <li class="${calendarDate < startOfToday ? 'filler' : ''}">
          <p class="mb-1 one-line px-1 text-end"><span class="${calendarDate.getTime() === startOfTodayTime ? 'badge rounded-pill text-bg-danger' : ''}" ="">${new Intl.DateTimeFormat([], { day: 'numeric' }).format(calendarDate)}</span></p>
          ${events && events.length > 0 ? events.map(event => {
        return `
            <a class="d-block pb-4" data-bs-target="#event-${event.id}" data-bs-toggle="modal" style="border-top: ${event[computedSymbol].startDay === event[computedSymbol].endDay ? '.25rem' : '.5rem'} solid ${event[computedSymbol].calendarData.color}">
            <p class="my-0 one-line px-1 text-muted"><small>${event.start.dateTime ? startTimeForEvent(event, day) : 'All-day'}</small></p>
            <p class="my-0 one-line px-1">${event.summary}</p>
            ${event.location ? `<p class="my-0 one-line px-1 text-muted"><small>${event.location}</small></p>` : ''}
          </a>
            `;
          }).join('') : (calendarDate.getTime() === startOfTodayTime ? '<p class="my-0 no-trails one-line px-1 text-muted" style="border-top: .25rem solid var(--bs-body-color)"><small>Today</small></p><p class="px-1 no-trails">No trails.</p>' : '')}
        </li>
      `;
    }

    function getUpcomingEventsView() {
      const regoEvents = allEvents.filter(event => {
        return (event.description || '').toLowerCase().includes('rego');
      });
      // const filteredAllDayEvents = allDayEvents.filter(allDayEvent => {
      //   const endDate = allDayEvent.end.dateTime ? new Date(allDayEvent.end.dateTime) : stringToDate(allDayEvent.end.date);
      //   const hasEndedBeforeNow = endDate.getTime() < today.getTime();
      //   return hasEndedBeforeNow === false && allDayEvent.summary.toLowerCase().includes('no oc hump') === false && allDayEvent.summary.toLowerCase().includes('no ochhh') === false;
      // });
      return (regoEvents.length > 0) ? `
        <div class="list-group mx-2">
          ${regoEvents.sort(sortByStartDate).map(event => {
        const description = [
          `<small class="text-muted">${getRangeForEvent(event)}</small>`,
          event.summary,
          event.location ? `<small class="text-muted">${event.location}</small>` : ''
        ].filter(part => part).join('<br>');
        return `
              <a class="list-group-item list-group-item-action" data-bs-target="#event-${event.id}" data-bs-toggle="modal">${description}</a>
            `;
      }).join('')}
        </div>
      ` : '';
    }

    document.body.innerHTML = `
      ${allEvents.map(event => {
        return `
          <div aria-hidden="true" aria-labelledby="event-${event.id}-title" class="fade modal" id="event-${event.id}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-lg-down modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="event-${event.id}-title">${event.summary}</h5>
                  <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                  <p>${getRangeForEvent(event)}</p>
                  <hr>
                  <p>
                    ${event.location ? `
                      ${event.location}
                      (<a href="http://maps.apple.com/?q=${encodeURIComponent(event.location)}" target="_blank">Apple&nbsp;Maps</a>
                      | <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}" target="_blank">Google&nbsp;Maps</a>)
                    ` : 'No location provided.'}
                  </p>
                  <hr>
                  <p>${event.description ? event.description.replaceAll('\n', '<br>') : 'No description provided.'}</p>
                  <hr>
                  <p><small class="text-muted">Last updated on ${new Intl.DateTimeFormat([], { dateStyle: 'full', timeStyle: 'short' }).format(new Date(event.updated))} on the “${event.organizer.displayName || event[computedSymbol].calendar.summary}” calendar.</small></p>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('')}
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
          <h1><a class="navbar-brand" href="./">H3 in SoCal</a></h1>
          <ul class="nav nav-pills">
            ${getNavContents()}
          </ul>
        </div>
      </nav>
      <main>${getMainContents()}</main>
    `;
  });
});

function getRangeForEvent(event) {
  const endDate = event.end.dateTime ? new Date(event.end.dateTime) : stringToDate(event.end.date);
  const startDate = event.start.dateTime ? new Date(event.start.dateTime) : stringToDate(event.start.date);
  if (event.end.date && event.start.date) {
    const realEndDate = new Date((new Date(endDate)).setDate(endDate.getDate() - 1));
    if (startDate.getTime() === realEndDate.getTime()) {
      return new Intl.DateTimeFormat([], { dateStyle: 'full' }).format(startDate);
    }
  }
  return new Intl.DateTimeFormat([], { dateStyle: 'full', timeStyle: 'short' }).formatRange(startDate, endDate);
}

function sortByStartDate(a, b) {
  const aDate = new Date(a.start.dateTime || a.start.date);
  const bDate = new Date(b.start.dateTime || b.start.date);
  return aDate - bDate;
}

function stringToDate(dateString) {
  const split = dateString.split('-');
  const year = Number(split[0]);
  const month = Number(split[1]) - 1;
  const day = Number(split[2]);
  return new Date(year, month, day);
}
